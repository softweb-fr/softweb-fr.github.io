<!doctype html><html lang=fr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=generator content="Hugo 0.121.1"><meta name=description content="Je partage ici un retour d‚Äôexp√©rience que j‚Äôai fait √† mon travail chez Koala.
Les besoins Je cherche √† avoir un HTTP Logger qui trace les HTTP Requests et les HTTP Responses.
Je veux pouvoir logger aussi bien les requests 404 (aucune route d√©finies) que les requ√™te qui succeed ou m√™me celles qui throw une erreur.
Comment √ßa marche aujourd‚Äôhui Aujourd‚Äôhui on a un LoggerInterceptor qui intercepte la requ√™te pour les logger, et attend la r√©ponse pour la logger aussi."><link rel=stylesheet href=https://softweb.fr/css/normalize.css><link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel=stylesheet type=text/css><link rel=stylesheet href=https://softweb.fr/css/cayman.ea0e967413f3851071cc8ace3621bc4205fe8fa79b2abe3d7bf94ff2841f0d47.css><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><title>NestJS Request Logger | Softweb</title></head><body><section class=page-header><h1 class=project-name>SOFTWEB.FR</h1><h2 class=project-tagline>Don&rsquo;t touch my closure!</h2><nav><a href=/ class=btn>Blog</a>
<a href=/tags/ class=btn>Tags</a>
<a href=/index.xml class=btn>RSS</a></nav></section><section class=main-content><h1>NestJS Request Logger</h1><div><strong>Publish date: </strong>2021-05-22</div><div><strong>Tags: </strong>&lt;a href="https://softweb.fr/tags/nestjs/">nestjs&lt;/a></div><p>Je partage ici un retour d&rsquo;exp√©rience que j&rsquo;ai fait √† mon travail chez <a href=https://www.hikoala.co/>Koala</a>.</p><h2 id=les-besoins>Les besoins</h2><p>Je cherche √† avoir un HTTP Logger qui trace les HTTP Requests et les HTTP Responses.</p><p>Je veux pouvoir logger aussi bien les requests 404 (aucune route d√©finies) que les requ√™te qui succeed ou m√™me celles qui throw une erreur.</p><h2 id=comment-√ßa-marche-aujourdhui>Comment √ßa marche aujourd&rsquo;hui</h2><p>Aujourd&rsquo;hui on a un <code>LoggerInterceptor</code> qui intercepte la requ√™te pour les logger, et attend la r√©ponse pour la logger aussi.</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:green;font-weight:700>@Injectable</span>({ scope: <span style=color:#b00040>Scope.REQUEST</span> })
</span></span><span style=display:flex><span><span style=color:green;font-weight:700>export</span> <span style=color:green;font-weight:700>class</span> LoggerInterceptor <span style=color:green;font-weight:700>implements</span> NestInterceptor {
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>public</span> <span style=color:green;font-weight:700>constructor</span>(<span style=color:green;font-weight:700>private</span> <span style=color:green;font-weight:700>readonly</span> httpLoggerService: <span style=color:#b00040>HttpLoggerService</span>) {}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>public</span> intercept(
</span></span><span style=display:flex><span>    context: <span style=color:#b00040>ExecutionContext</span>,
</span></span><span style=display:flex><span>    next: <span style=color:#b00040>CallHandler</span>&lt;<span style=color:green;font-weight:700>unknown</span>&gt;,
</span></span><span style=display:flex><span>  )<span style=color:#666>:</span> Observable&lt;<span style=color:green;font-weight:700>unknown</span>&gt; <span style=color:#666>|</span> Promise&lt;<span style=color:green;font-weight:700>Observable</span><span>&lt;</span><span style=color:#7d9029>unknown</span>&gt;<span style=color:#666>&gt;</span> {
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>const</span> httpContext <span style=color:#666>=</span> context.switchToHttp();
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>const</span> { originalUrl: <span style=color:#b00040>url</span>, method, params, query, body, headers, ip } <span style=color:#666>=</span> httpContext.getRequest&lt;<span style=color:green;font-weight:700>Request</span>&gt;();
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>const</span> response <span style=color:#666>=</span> httpContext.getResponse&lt;<span style=color:green;font-weight:700>Response</span>&gt;();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>const</span> obfuscatedHeaders <span style=color:#666>=</span> obfuscateHeaders(headers);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>this</span>.httpLoggerService.logRequest({ url, method, params, query, headers: <span style=color:#b00040>obfuscatedHeaders</span>, body, ip });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>return</span> next.handle().pipe(
</span></span><span style=display:flex><span>      tap((responseBody) <span style=color:#666>=&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>this</span>.httpLoggerService.logResponse({
</span></span><span style=display:flex><span>          statusCode: <span style=color:#b00040>response.statusCode</span>,
</span></span><span style=display:flex><span>          headers: <span style=color:#b00040>response.getHeaders</span>(),
</span></span><span style=display:flex><span>          body: <span style=color:#b00040>responseBody</span>,
</span></span><span style=display:flex><span>        }),
</span></span><span style=display:flex><span>      ),
</span></span><span style=display:flex><span>    );
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>On a un <code>AnyExceptionFilter</code> qui intercepte toutes les exceptions qui remonte dans NestJS pour les logger.</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:green;font-weight:700>@Catch</span>()
</span></span><span style=display:flex><span><span style=color:green;font-weight:700>export</span> <span style=color:green;font-weight:700>class</span> AnyExceptionFilter <span style=color:green;font-weight:700>implements</span> ExceptionFilter {
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>public</span> <span style=color:green;font-weight:700>constructor</span>(<span style=color:green;font-weight:700>private</span> <span style=color:green;font-weight:700>readonly</span> <span style=color:green;font-weight:700>module</span>Ref<span style=color:#666>:</span> ModuleRef) {}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>async</span> <span style=color:green;font-weight:700>catch</span>(exception: <span style=color:#b00040>unknown</span>, host: <span style=color:#b00040>ArgumentsHost</span>)<span style=color:#666>:</span> Promise&lt;<span style=color:green;font-weight:700>void</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>const</span> ctx <span style=color:#666>=</span> host.switchToHttp();
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>const</span> request <span style=color:#666>=</span> ctx.getRequest();
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>const</span> response <span style=color:#666>=</span> ctx.getResponse&lt;<span style=color:green;font-weight:700>Response</span>&gt;();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>const</span> httpException <span style=color:#666>=</span>
</span></span><span style=display:flex><span>      exception <span style=color:green;font-weight:700>instanceof</span> HttpException <span style=color:#666>?</span> exception : <span style=color:#b00040>new</span> InternalServerErrorException(<span style=color:#ba2121>&#39;Internal Server Error&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>const</span> contextId <span style=color:#666>=</span> ContextIdFactory.create();
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>this</span>.<span style=color:green;font-weight:700>module</span>Ref.registerRequestByContextId(request, contextId);
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>const</span> httpLoggerService <span style=color:#666>=</span> <span style=color:green;font-weight:700>await</span> <span style=color:green;font-weight:700>this</span>.<span style=color:green;font-weight:700>module</span>Ref.resolve(HttpLoggerService, contextId);
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>const</span> statusCode <span style=color:#666>=</span> httpException.getStatus();
</span></span><span style=display:flex><span>    httpLoggerService.logResponse({ statusCode, body: <span style=color:#b00040>exception</span> });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    response.status(statusCode).send(httpException.getResponse());
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=le-probl√®me>Le probl√®me</h2><p>Si je fais une requ√™te classique tout va bien:</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-JSON data-lang=JSON><span style=display:flex><span>{<span style=color:green;font-weight:700>&#34;requestId&#34;</span>:<span style=color:#ba2121>&#34;...d76&#34;</span>,<span style=color:green;font-weight:700>&#34;type&#34;</span>:<span style=color:#ba2121>&#34;REQUEST&#34;</span>,<span>...</span>}
</span></span><span style=display:flex><span>{<span style=color:green;font-weight:700>&#34;requestId&#34;</span>:<span style=color:#ba2121>&#34;...d76&#34;</span>,<span style=color:green;font-weight:700>&#34;type&#34;</span>:<span style=color:#ba2121>&#34;RESPONSE&#34;</span>,<span>...</span>}
</span></span></code></pre></div><p>Si je tape sur une route qui n&rsquo;existe pas:</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-JSON data-lang=JSON><span style=display:flex><span>{<span style=color:green;font-weight:700>&#34;requestId&#34;</span>:<span style=color:#ba2121>&#34;...59e&#34;</span>,<span style=color:green;font-weight:700>&#34;statusCode&#34;</span>:<span style=color:#666>404</span>,<span style=color:green;font-weight:700>&#34;body&#34;</span>:<span style=color:#ba2121>&#34;NotFoundException [Error]: ...&#34;</span>,<span style=color:green;font-weight:700>&#34;type&#34;</span>:<span style=color:#ba2121>&#34;RESPONSE&#34;</span>,<span>...</span>}
</span></span></code></pre></div><p>L√† je n&rsquo;ai pas la requ√™te.</p><p>Et maintenant, si j&rsquo;ai une erreur qui est thrown dans le controlleur:</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-JSON data-lang=JSON><span style=display:flex><span>{<span style=color:green;font-weight:700>&#34;requestId&#34;</span>:<span style=color:#ba2121>&#34;...ef4&#34;</span>,<span style=color:green;font-weight:700>&#34;type&#34;</span>:<span style=color:#ba2121>&#34;REQUEST&#34;</span>,<span>...</span>}
</span></span><span style=display:flex><span>{<span style=color:green;font-weight:700>&#34;requestId&#34;</span>:<span style=color:#ba2121>&#34;...c5d&#34;</span>,<span style=color:green;font-weight:700>&#34;statusCode&#34;</span>:<span style=color:#666>500</span>,<span style=color:green;font-weight:700>&#34;body&#34;</span>:<span style=color:#ba2121>&#34;Error: ...&#34;</span>,<span style=color:green;font-weight:700>&#34;type&#34;</span>:<span style=color:#ba2121>&#34;RESPONSE&#34;</span>,<span>...</span>}
</span></span></code></pre></div><p>L&rsquo;id de la request n&rsquo;est pas la m√™me l&rsquo;id de la r√©ponse.</p><h2 id=lexplication>L&rsquo;explication</h2><p>Le <code>LoggerInterceptor</code> est scopp√© √† une request <code>@Injectable({ scope: Scope.REQUEST })</code> or <code>AnyExceptionFilter</code> ne l&rsquo;est pas.</p><p>Un composant scopp√© √† une request ne va √™tre instanci√© que lorsque qu&rsquo;une route est r√©solue. Du coup en cas de 404, le <code>LoggerInterceptor</code> n&rsquo;est pas instanci√© et donc la requ√™te n&rsquo;est pas logger. J&rsquo;ai besoin de ce scope, car c&rsquo;est comme √ßa que je peux d√©finir un id par request.</p><p><code>AnyExceptionFilter</code> a lui aussi besoin du context de la request pour construire un <code>HttpLoggerService</code>. Il le r√©cup√®re par un m√©canisme document√© par NestJS: <a href=https://docs.nestjs.com/fundamentals/module-ref#retrieving-instances>https://docs.nestjs.com/fundamentals/module-ref#retrieving-instances</a></p><p>Le probl√®me c&rsquo;est qu&rsquo;au lieu d&rsquo;essayer de r√©cup√©rer un <code>HttpLoggerService</code> existant, on cr√©e syst√©matiquement un nouveau contexte et on demande le <code>HttpLoggerService</code> pour ce contexte:</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:green;font-weight:700>const</span> contextId <span style=color:#666>=</span> ContextIdFactory.create();
</span></span><span style=display:flex><span><span style=color:green;font-weight:700>this</span>.<span style=color:green;font-weight:700>module</span>Ref.registerRequestByContextId(request, contextId);
</span></span><span style=display:flex><span><span style=color:green;font-weight:700>const</span> httpLoggerService <span style=color:#666>=</span> <span style=color:green;font-weight:700>await</span> <span style=color:green;font-weight:700>this</span>.<span style=color:green;font-weight:700>module</span>Ref.resolve(HttpLoggerService, contextId);
</span></span></code></pre></div><p>√áa explique le fait que la request et la response error n&rsquo;ont sont pas le m√™me id.</p><h2 id=la-solution>La solution</h2><p>En creusant un peu dans les internals, j&rsquo;ai trouv√© que NestJS avait son propre m√©canisme pour identifier des requests. C&rsquo;est pas document√© et j&rsquo;ai trouv√© des issues qui en parlent, mais pas d&rsquo;autre solution que le workaround que j&rsquo;ai trouv√©.</p><p>Concr√®tement je vais r√©cup√©rer le internalId que NestJS set sur l&rsquo;objet request pour retrouver le <code>HttpLoggerService</code> de la request:</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:green;font-weight:700>let</span> contextId <span style=color:#666>=</span> request[REQUEST_CONTEXT_ID];
</span></span><span style=display:flex><span><span style=color:green;font-weight:700>const</span> contextIdWasNotDefined <span style=color:#666>=</span> contextId <span style=color:#666>===</span> <span style=color:green;font-weight:700>undefined</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:green;font-weight:700>if</span> (contextIdWasNotDefined) {
</span></span><span style=display:flex><span>  contextId <span style=color:#666>=</span> ContextIdFactory.create();
</span></span><span style=display:flex><span>  request[REQUEST_CONTEXT_ID] <span style=color:#666>=</span> contextId;
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>this</span>.<span style=color:green;font-weight:700>module</span>Ref.registerRequestByContextId(request, contextId);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:green;font-weight:700>const</span> httpLoggerService <span style=color:#666>=</span> <span style=color:green;font-weight:700>await</span> <span style=color:green;font-weight:700>this</span>.<span style=color:green;font-weight:700>module</span>Ref.resolve(HttpLoggerService, contextId);
</span></span></code></pre></div><p>Si le internalId n&rsquo;est pas set, c&rsquo;est que le context n&rsquo;a pas √©t√© cr√©√© par NestJS (404). Je cr√©e donc un internalId que je set sur la request et j&rsquo;enregistre la request avec cet id dans NestJS.</p><p>C&rsquo;est pas id√©al, je pr√©f√®rerais pass√© par des helpers fournis par NestJS pour trouver l&rsquo;id d&rsquo;un context √† partir d&rsquo;une request. Mais √ßa n&rsquo;existe visiblement pas. Donc en attendant&mldr; üòÖ</p><div id=disqus_thread></div><script>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//softweb-fr.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a><footer class=site-footer><span class=site-footer-credits>Sources on <a href=https://github.com/softweb-fr/softweb-fr.github.io>Github</a>. Made with <a href=https://gohugo.io/>Hugo</a>. Themed by <a href=https://github.com/zwbetz-gh/cayman-hugo-theme>Cayman</a>.</span></footer></section><script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-43088213-1","auto"),ga("send","pageview")</script><script async src=https://www.google-analytics.com/analytics.js></script></body></html>